main: http_server
modules: 
  - module: http_server
    version: latest
    with:
      port: 8080
  - module: amqp
    version: latest
    with:
      host: localhost
      routing_key: striper.routing.key
      queue_name: striper.queue
      exchange: striper.exchange
      username: guest
      password: guest
      vhost: /
      definition:
        vhosts:
          - name: /
        exchanges:
          - name: striper.exchange
            vhost: /
            type: direct
            durable: true
            auto_delete: false
            internal: false
            arguments: {}
        queues:
          - name: striper.queue
            vhost: /
            durable: true
            auto_delete: false
            arguments: {}
        bindings:
          - source: striper.exchange
            vhost: /
            destination: striper.queue
            destination_type: queue
            routing_key: striper.routing.key
            arguments: {}
steps:
  - condition:
      assert: !phs main.method == "POST"
    then: 
      steps:
        - id: queue
          use: amqp
          input:
            message: !phs main
        - return:
            status_code: 201
            body:
              message: "Message sent successfully"
              response: !phs steps.queue
            headers:
              Content-Type: application/json
    else:
      return:
        status_code: 400
        body:
          message: "Invalid contract"
        headers:
          Content-Type: application/json

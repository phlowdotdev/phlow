modules:
  - module: log
steps:
  - id: storage
    payload: payload ?? main
  - log:
      level: when steps.storage.len % 2 == 0 ? "warn" : "error"
      message: steps.storage[-1].content
  - openai:
      action: chat
      messages: steps.storage
  - payload: {
      let storage = [...steps.storage];
      storage.push(payload.data.choices[0].message);

      let messages = [];

      for (msg, index) in storage {
          let role = if storage.len % 2 == 0 {
              if index % 2 == 0 {
                  "assistant"
              } else {
                  "user"
              }
          } else {
              if index % 2 == 0 {
                  "user"
              } else {
                  "assistant"
              }
          };
          messages.push({
              role: role,
              content: msg.content
          });
      }
      messages
    }

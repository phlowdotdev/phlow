name: test_http_server
version: 0.1
main: http_server
modules:
  - module: http_server
    version: latest
    with:
      port: 9001
      openapi_spec:
        openapi: "3.0.0"
        info:
          title: "User API"
          version: "1.0.0"
        paths:
          /api/v1/users:
            post:
              requestBody:
                required: true
                content:
                  application/json:
                    schema:
                      $ref: "#/components/schemas/NewUser"
              responses:
                '201':
                  description: User created
                  content:
                    application/json:
                      schema:
                        $ref: "#/components/schemas/User"
                '400':
                  description: Validation error
        components:
          schemas:
            NewUser:
              type: object
              required:
                - name
                - email
              properties:
                name:
                  type: string
                  pattern: '^[a-zA-ZÀ-ÿ ]+$'
                  minLength: 2
                  maxLength: 100
                email:
                  type: string
                  format: email
                  pattern: '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
                phone:
                  type: string
                  pattern: '^\+?[1-9]\d[\d \-\(\)]{7,15}$'
                  minLength: 8
                  maxLength: 20
                age:
                  type: integer
                  minimum: 0
                  maximum: 150
            User:
              type: object
              properties:
                id:
                  type: integer
                name:
                  type: string
                email:
                  type: string
                phone:
                  type: string
                age:
                  type: integer
                created_at:
                  type: string
                  format: date-time
steps:
  - echo:
      message: !phs method
      to_console: false
  - echo:
      message: !phs path
      to_console: false
  - echo:
      message: !phs body
      to_console: false
  - if:
      condition: !phs method == "POST" && path == "/api/v1/users"
      then:
        - return:
            status_code: 201
            body:
              id: 1
              name: !phs body.name
              email: !phs body.email
              phone: !phs body.phone
              age: !phs body.age
              created_at: "2024-08-12T20:00:00Z"
            headers:
              Content-Type: application/json
      else:
        - return:
            status_code: 404
            body:
              error: "Not Found"
            headers:
              Content-Type: application/json
